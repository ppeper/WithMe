# ì™¸ë¶€ ì„œë¹„ìŠ¤ ì •ë¦¬ ë¬¸ì„œ

ì‘ì„±ì¼ì‹œ: 2023ë…„ 8ì›” 16ì¼ ì˜¤í›„ 11:45

## í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì™¸ë¶€ ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ì •ë¦¬í•œ ë¬¸ì„œ

# ğŸ“Œëª¨ë°”ì¼

## Fire Cloud Messaging

FCMì—ì„œ ìƒì„±í•œ `google-service.json` íŒŒì¼ì„ í”„ë¡œì íŠ¸ `app`ì— ë„£ì–´ì¤€ë‹¤.

![image](/uploads/b2ec15a5b8139379b160b2975b155ac2/image.png)

## API Key
ì•ˆë“œë¡œì´ë“œ í”„ë¡œì íŠ¸ì— `local.properties` ì•ˆì— API Key ê°’ì„ ì…ë ¥í•´ì¤€ë‹¤.

```
api_key="https://i9d105.p.ssafy.io/"
image_base_url="https://bonobono.s3.ap-northeast-2.amazonaws.com"
```

# ğŸ“Œë°±ì•¤ë“œ 

## Fire Cloud Messaging

### FCM ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸°

FCMì—ì„œ ìƒì„±í•œ í”„ë¡œì íŠ¸ì˜ ë¹„ê³µê°œ í‚¤ JSONíŒŒì¼(Javaìš©)ì„ í”„ë¡œì íŠ¸ íŒŒì¼ì— ë„£ì–´ì¤€ë‹¤.

![Untitled](/uploads/e6ea7909609df01fc920cb28e5514c09/Untitled.png)

build.gradleì— firebase íŒ¨í‚¤ì§€ë¥¼ ë“±ë¡í•´ì¤€ë‹¤.

```java
implementation 'com.google.firebase:firebase-admin:9.1.1'
```

FCMì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Spring Bootì— Configurationì„ ë“±ë¡í•´ì¤€ë‹¤.

```java
@Configuration
public class FCMConfig {

    @Bean
    FirebaseMessaging firebaseMessaging() throws IOException{
        ClassPathResource resource = new ClassPathResource("firebase/bonobono-2a773-firebase-adminsdk-70319-9beeb00ab4.json");

        InputStream refreshToken = resource.getInputStream();

        FirebaseApp firebaseApp = null;
        List<FirebaseApp> firebaseAppList = FirebaseApp.getApps();

        if (firebaseAppList != null && !firebaseAppList.isEmpty()){
            for (FirebaseApp app : firebaseAppList) {
                if (app.getName().equals(FirebaseApp.DEFAULT_APP_NAME)){
                    firebaseApp = app;
                }
            }
        } else {
            FirebaseOptions options = FirebaseOptions.builder()
                    .setCredentials(GoogleCredentials.fromStream(refreshToken))
                    .build();

            firebaseApp = FirebaseApp.initializeApp(options);
        }

        return FirebaseMessaging.getInstance(firebaseApp);
    }
}
```

FCM ì„œë²„ì— ë³´ë‚´ê¸° ìœ„í•œ RequestDto

```java
@Getter
@NoArgsConstructor
public class FCMNotificationRequestDto {
    private Long memberId;
    private String title;
    private String body;

    @Builder
    public FCMNotificationRequestDto(Long memberId, String title, String body){
        this.memberId = memberId;
        this.title = title;
        this.body = body;
    }
}
```

ë¡œê·¸ì¸ì„ í•˜ë©´ ì‚¬ìš©ìì—ê²Œ FCM í† í°ì„ ë°œê¸‰ ë°›ê²Œ í•˜ê¸° ìœ„í•œ ë¡œì§

```java
@Service
public class FCMService {

    private final ObjectMapper objectMapper;

    @Autowired
    public FCMService(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }

    public String getAccessToken() throws IOException {
        // firebaseë¡œ ë¶€í„° access tokenì„ ê°€ì ¸ì˜¨ë‹¤.

        GoogleCredentials googleCredentials = GoogleCredentials
            .fromStream(new ClassPathResource("firebase/bonobono-2a773-firebase-adminsdk-70319-9beeb00ab4.json").getInputStream())
            .createScoped(Arrays.asList("https://www.googleapis.com/auth/cloud-platform"));

        googleCredentials.refreshIfExpired();

        return googleCredentials.getAccessToken().getTokenValue();
    }

}
```

ì‚¬ìš©ìì— ë“±ë¡ëœ FCM í† í°ì„ ì¡°íšŒí•˜ê³  FCM ì„œë²„ì— ì•Œë¦¼ì„ ë³´ë‚´ë„ë¡ ìš”ì²­í•˜ëŠ” Service

```java
public String sendNotificationByToken(FCMNotificationRequestDto requestDto){

        Optional<Member> member = memberRepository.findById(requestDto.getMemberId());
        Optional<Token> token = tokenRepository.findByKey(Long.toString(requestDto.getMemberId()));

        if(member.isPresent()) {
            if (token.isPresent() && token.get().getFcmtoken() != null) {
                Notification notification = Notification.builder()
                        .setTitle(requestDto.getTitle())
                        .setBody(requestDto.getBody())
                        .build();

                Message message = Message.builder()
                        .setToken(token.get().getFcmtoken())
                        .setNotification(notification)
                        .build();

                try {
                    firebaseMessaging.send(message);
                    return "ì•Œë¦¼ì„ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. memberId=" + requestDto.getMemberId();
                } catch (FirebaseMessagingException e) {
                    e.printStackTrace();
                    return "ì•Œë¦¼ì„ ë³´ë‚´ê¸°ë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. memberId=" + requestDto.getMemberId();
                }
            } else {
                return "ì„œë²„ì— ì €ì¥ëœ í•´ë‹¹ ìœ ì €ì˜ FirebaseTokenì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. targetUserId=" +
                        requestDto.getMemberId();
            }
        } else {
            return "í•´ë‹¹ ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. memberId=" + requestDto.getMemberId();
        }
    }
```

## AWS S3ë¥¼ ì´ìš©í•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë‹¤ìš´ë¡œë“œ

### AWS S3 ë²„í‚· ìƒì„±

ì´ í”„ë¡œì íŠ¸ëŠ” ì»¤ë®¤ë‹ˆí‹°, ì±„íŒ…ê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•˜ì˜€ê¸°ì— ë§ì€ ë¯¸ë””ì–´íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë‹¤ìš´ë¡œë“œ ë°›ì„ ì¼ì´ ë§ë‹¤ê³  ìƒê°í•˜ì—¬ ë¡œì»¬ì´ ì•„ë‹Œ AWS S3ì— ë¯¸ë””ì–´íŒŒì¼ì„ ì €ì¥í•˜ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

![Untitled_1](/uploads/852261ee756654187ee689a0a9825459/Untitled_1.png)

AWS S3ì— ë²„í‚·ì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.

![Untitled_2](/uploads/16f232541b965f82a0be8effe74d865a/Untitled_2.png)

ë„ë©”ì¸ì— ë§ëŠ” ê°ì²´ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

![Untitled_3](/uploads/a4cf3215b8dfd54c7455ac5b24e21445/Untitled_3.png)

### AWS IAM ì„¤ì •

S3 ë²„í‚·ì˜ íŒŒì¼ì„ ì—…ë¡œë“œ, ë‹¤ìš´ë¡œë“œ, ì‚­ì œ ë“±ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.

ê¶Œí•œì„ ìœ„í•´ì„œ AWS IAMì„ ì´ìš©í•©ë‹ˆë‹¤.

AWS IAMì€ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ì œì–´í•˜ëŠ” ê¶Œí•œì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Untitled_4](/uploads/b6938866d1a24242f346c2424015aa25/Untitled_4.png)

ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ê³  ê¶Œí•œì€ S3ì˜ ëª¨ë“  ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ” AmazonS3FullAccessìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. 

![Untitled_5](/uploads/264b4d4ba0449f8b980e6ccf4a639e98/Untitled_5.png)

S3ì˜ ê¶Œí•œì„ ë°›ì€ ì‚¬ìš©ìì˜ ì•¡ì„¸ìŠ¤í‚¤ì™€ ì‹œí¬ë¦¿í‚¤ë¥¼ ìŠ¤í”„ë§ë¶€íŠ¸ application.ymlì— ì‘ì„±í•´ì¤ë‹ˆë‹¤.

![Untitled_6](/uploads/1d04c530ad42c299d84e9a259cac429d/Untitled_6.png)

### S3 ì—…ë¡œë“œë¥¼ ìœ„í•œ Java ì½”ë“œ

ì´ì œ S3ì— ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œ í•´ë³´ê² ìŠµë‹ˆë‹¤.

ìš°ì„  build.gradleì— aws ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë°›ì•„ì¤ë‹ˆë‹¤.

```groovy
implementation 'io.awspring.cloud:spring-cloud-starter-aws:2.4.2'
```

ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ì— S3ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Configurationì„ ë“±ë¡í•´ì¤ë‹ˆë‹¤.

```java
@Configuration
public class S3Config {

    @Value("${cloud.aws.credentials.access-key}")
    private String accessKey;

    @Value("${cloud.aws.credentials.secret-key}")
    private String secretKey;

    @Value("${cloud.aws.region.static}")
    private String region;

    @Bean
    public AmazonS3 amazonS3() {

        BasicAWSCredentials awsCredentials  = new BasicAWSCredentials(accessKey, secretKey);

        return AmazonS3ClientBuilder.standard()
                .withRegion(region)
                .withCredentials(new AWSStaticCredentialsProvider(awsCredentials))
                .build();
    }

}
```

ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê¸° ìœ„í•´ Base64 ì¸ì½”ë”© í˜•ì‹ì´ ì•„ë‹Œ MultipartFile í˜•ì‹ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

ì¸ì½”ë”©, ë””ì½”ë”© ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•Šì•„ë„ ë˜ê³  ìš©ëŸ‰ì´ ìƒëŒ€ì ìœ¼ë¡œ ì ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

S3ì— ì—…ë¡œë“œí•  ë•ŒëŠ” ì¤‘ë³µëœ ì´ë¯¸ì§€ ì´ë¦„ì´ ìˆìœ¼ë©´ ì•ˆë˜ê¸°ì— ì´ë¦„ì— UUIDë¥¼ í™œìš©í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.

```java
@RequiredArgsConstructor
@Service
public class AwsS3Service {

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    private final AmazonS3 amazonS3;

    /**
     * AWS S3ì— ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ
     * @param multipartFile : íŒŒì¼
     * @param dirName : s3 ë²„í‚·ì—ì„œ ë§Œë“¤ì–´ì¤€ í´ë” ì´ë¦„
     * @return : Url
     */
    public URL upload(MultipartFile multipartFile, String dirName){

        String fileName = createFileName(multipartFile.getOriginalFilename(), dirName);

        // s3ì— ì´ë¯¸ì§€ ì €ì¥
        try(InputStream inputStream = multipartFile.getInputStream()){
            ObjectMetadata metadata = new ObjectMetadata();
            byte[] bytes = IOUtils.toByteArray(inputStream);
            metadata.setContentLength(bytes.length);
            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
            amazonS3.putObject(new PutObjectRequest(bucket, fileName, byteArrayInputStream, metadata));
        } catch (IOException e){
            // ì˜ˆì™¸ì²˜ë¦¬
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

        // s3ì— ì €ì¥ëœ íŒŒì¼ url ì–»ì–´ì˜´.
        return amazonS3.getUrl(bucket, fileName);
    }

    // íŒŒì¼ ì´ë¦„ì´ ê°™ìœ¼ë©´ ì €ì¥ì´ ì•ˆ ëœë‹¤. ë”°ë¼ì„œ íŒŒì¼ì´ë¦„ ì•ì— UUIDë¥¼ ë¶™ì¸ë‹¤.
    private String createFileName(String fileName, String dirName){
        return dirName + "/" + UUID.randomUUID() + fileName;
    }

    public void delete(String imageUrl, String dirName) {
        try {
            String keyName = URLDecoder.decode(dirName + "/" + imageUrl.split("/")[2], StandardCharsets.UTF_8);
            System.out.println(keyName);
            boolean isFileExist = amazonS3.doesObjectExist(bucket, keyName);
            System.out.println(isFileExist);
            if (isFileExist) {
                amazonS3.deleteObject(bucket, keyName);
            } else {
                throw new IllegalArgumentException("í•´ë‹¹ ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        } catch (Exception e){
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
        }

    }
}
```

### S3ì— ì—…ë¡œë“œ ëœ ì´ë¯¸ì§€ íŒŒì¼

ssafyë¼ëŠ” ì´ë¯¸ì§€íŒŒì¼ì´ S3 ë²„í‚·ì— ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.

![Untitled_7](/uploads/f7ae8b54c067d6a57c4c8774e7513f03/Untitled_7.png)

ì—…ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ê°ì²´ URL ì£¼ì†Œë¥¼ í™œìš©í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Untitled_8](/uploads/cc0041bee3efd93622adf322328e9d9a/Untitled_8.png)

### S3 í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ê¶Œí•œ

Frontì—ì„œ ê°ì²´ URLë¡œ ì´ë¯¸ì§€ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´ì„œëŠ” í¼ë¸”ë¦­ ì ‘ì† ê¶Œí•œì´ í•„ìš”í•˜ë‹¤.

ê·¸ë˜ì„œ í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨ ì²´í¬ë¥¼ í•´ì œ í•´ì£¼ê³  ë²„í‚· ì •ì±…ì— í•´ë‹¹ JSONì„ ì‘ì„±í•´ì£¼ì

![Untitled_9](/uploads/2482bd427a6f8eee9ea7b4e0895f6a83/Untitled_9.png)

```java
{
    "Version": "2012-10-17",
    "Id": "Policy1690874389113",
    "Statement": [
        {
            "Sid": "Stmt1690874387067",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject", // S3 ê°ì²´ë¥¼ ì¡°íšŒí•˜ëŠ” ì‘ì—…
            "Resource": "arn:aws:s3:::bonobono/*"
        }
    ]
}
```

## Swagger 3

### ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ Swaager 3 ì‚¬ìš©í•˜ê¸°

Springì—ì„œ Swaggerë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Springfoxì™€ SpringDocê°€ ìˆëŠ”ë°,

ìµœê·¼ì€ ì„¸íŒ…í•˜ê¸° ë” ì‰¬ìš´ SpringDocì„ ë§ì´ ì‚¬ìš©í•˜ëŠ” ì¶”ì„¸ì´ë‹¤.

ì˜ì¡´ì„± ì¶”ê°€

```groovy
implementation group: 'org.springdoc', name: 'springdoc-openapi-ui', version: '1.6.9'
```

application.yml

```groovy
spring:
	mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

springdoc:
  default-consumes-media-type: application/json
  default-produces-media-type: application/json
  swagger-ui:
    path: /swagger-ui.html 
    disable-swagger-default-url: true // Swagger3 ê¸°ë³¸ Urlì„ Swagger2 Url ë°©ì‹ìœ¼ë¡œ ë°”ê¿ˆ
```

### Swagger3 ì–´ë…¸í…Œì´ì…˜

summaryì™€ descriptionì„ ì´ìš©í•´ í•´ë‹¹ ì»¨íŠ¸ë¡¤ëŸ¬ì— ëŒ€í•œ ì œëª©ê³¼ ì„¤ëª…ì„ ì‘ì„±í•´ì¤„ ìˆ˜ ìˆë‹¤.

```groovy
@Operation(summary = "ììœ ê²Œì‹œíŒ ê²Œì‹œê¸€ ê²€ìƒ‰", description = "í‚¤ì›Œë“œê°€ ì œëª©, ë‚´ìš© í¬í•¨")
    @GetMapping("/search")
    public ResponseEntity<List<ArticleListResponseDto>> search(@RequestParam("keyword") String keyword){
        List<ArticleListResponseDto> responseDto = articleService.search(type, keyword);
        return new ResponseEntity<>(responseDto, HttpStatus.OK);
    }
```

![Untitled_10](/uploads/90db1bfa52136bbea228c89a6897cd29/Untitled_10.png)

### Swaggerì—ì„œ https ì‚¬ìš© ë°©ë²•

SwaggerëŠ” ê¸°ë³¸ì ìœ¼ë¡œ httpë¡œ ìš”ì²­ì„ ë³´ë‚´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ë°, 

httpsë¥¼ ì‚¬ìš© ì‹œ CORSì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.

ê·¸ë˜ì„œ @SpringBootApplicationìœ„ì— í•´ë‹¹ annotationì„ ë‹¬ì•„ì£¼ì

```groovy
@OpenAPIDefinition(servers = {@Server(url="{ì›í•˜ëŠ” ë„ë©”ì¸}", description = "default server url")})
```
